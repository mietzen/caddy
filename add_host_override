#!/bin/sh
set -e
set -o pipefail

opnsense_hostname="$1"
domain="$2"
caddy_server_ip="$3"

log() {
    local ts level script
    level="$1"
    shift
    ts=$(date +"%y-%m-%d %H:%M:%S")
    script=$(basename "$0")
    echo "[$ts][$script][$level] $*"
}

# Validate input
if [ -z "$opnsense_hostname" ] || [ -z "$domain" ] || [ -z "$caddy_server_ip" ]; then
    echo "Usage: $0 <opnsense_hostname> <domain> <caddy_server_ip>" >&2
    [ -z "$opnsense_hostname" ] && echo "Error: <opnsense_hostname> is missing" >&2
    [ -z "$domain" ] && echo "Error: <domain> is missing" >&2
    [ -z "$caddy_server_ip" ] && echo "Error: <caddy_server_ip> is missing" >&2
    exit 1
fi

if [ -z "$OPNSENSE_API_KEY" ] || [ -z "$OPNSENSE_API_SECRET" ]; then
    log ERROR "Missing environment variable:" >&2
    [ -z "$OPNSENSE_API_KEY" ] && log ERROR "Error: OPNSENSE_API_KEY is missing" >&2
    [ -z "$OPNSENSE_API_SECRET" ] && log ERROR "Error: OPNSENSE_API_SECRET is missing" >&2
    exit 1
fi

if [ "$domain" = "${domain#*.}" ]; then
    log ERROR "Error: domain must contain a dot" >&2
    exit 1
fi

# Check IP type (IPv4 or IPv6)
check_ip_type() {
    if echo "$1" | grep -Eq '^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}$'; then
        return 0
    fi
    if echo "$1" | grep -Eq '^(([0-9a-fA-F]{1,4}:){1,7}[0-9a-fA-F]{0,4}|::1)$'; then
        return 0
    fi
    return 1
}

if ! check_ip_type "$caddy_server_ip" &> /dev/null; then
    log ERROR "Error: <caddy_server_ip> must be a valid IPv4 or IPv6 address" >&2
    log ERROR "Got: $caddy_server_ip" >&2
    exit 1
fi

# Parse domain components
host_part="${domain%%.*}"
domain_part="${domain#*.}"

# Set insecure flag if needed
insecure=""
if [ "$(printf '%s' "$OPNSENSE_INSECURE" | tr '[:upper:]' '[:lower:]')" = "true" ]; then
    insecure="-k"
fi

# Base URL for API calls
base_url="https://${opnsense_hostname}/api/dnsmasq/"
auth_params="-u ${OPNSENSE_API_KEY}:${OPNSENSE_API_SECRET}"

# Function to call OPNsense Dnsmasq API
opnsense_dnsmasq_api() {
    local endpoint="$1"
    local payload="$2"
    local method="${3:-POST}"
    local response
    local exit_code

    if [ -n "$payload" ]; then
        response=$(curl -sS -X "$method" $insecure \
            $auth_params \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$base_url/$endpoint" 2>&1)
        exit_code=$?
    else
        response=$(curl -sS -X "$method" $insecure \
            $auth_params \
            "$base_url/$endpoint" 2>&1)
        exit_code=$?
    fi

    if [ $exit_code -ne 0 ]; then
        if echo "$response" | grep -qi "self-signed certificate"; then
            log ERROR "Error: Failed to connect due to an self-signed SSL certificate." >&2
            log ERROR "Hint: If you are using a self-signed certificate, set OPNSENSE_INSECURE=true" >&2
        else
            log ERROR "Error: curl failed with exit code $exit_code" >&2
            log ERROR "$response" >&2
        fi
        return 1
    fi

    printf '%s\n' "$response"
}

log INFO "Managing host entry for: $host_part.$domain_part -> $caddy_server_ip"

# Build JSON payload for dnsmasq host
json_payload='{
    "host": {
        "host": "'"$host_part"'",
        "domain": "'"$domain_part"'",
        "ip": "'"$caddy_server_ip"'",
        "descr": "Generated by Caddy"
    }
}'

# Query existing hosts
log INFO "Checking for existing host entries..."
hosts_json=$(opnsense_dnsmasq_api "settings/search_host" "" "GET")

# Look for matching host + domain
match=$(printf '%s' "$hosts_json" | jq -r \
    --arg h "$host_part" \
    --arg d "$domain_part" \
    '.rows[] | select(.host == $h and .domain == $d)')

if [ -n "$match" ]; then
    uuid=$(printf '%s' "$match" | jq -r '.uuid')
    current_ip=$(printf '%s' "$match" | jq -r '.ip')
    current_desc=$(printf '%s' "$match" | jq -r '.descr')

    # Check if existing entry is identical
    if [ "$current_ip" = "$caddy_server_ip" ] && \
       [ "$current_desc" = "Generated by Caddy" ]; then
        log INFO "Host entry already exists and is identical"
        exit 0
    else
        log INFO "Host entry exists but differs:"
        log INFO "  Current: ip=$current_ip, desc=$current_desc"
        log INFO "  Desired: ip=$caddy_server_ip, desc=Generated by Caddy"
        log INFO "Deleting old entry..."

        delete_result=$(opnsense_dnsmasq_api "settings/del_host/${uuid}")
        if [ "$(printf '%s' "$delete_result" | jq -r '.result')" = "deleted" ]; then
            log INFO "Old entry deleted successfully"
        else
            log ERROR "Error: Failed to delete old entry. API response: $delete_result" >&2
            exit 1
        fi
    fi
else
    log INFO "Host entry does not exist yet"
fi

# Create new host entry
log INFO "Creating new host entry..."

add_result=$(opnsense_dnsmasq_api "settings/add_host" "$json_payload")

if [ "$(printf '%s' "$add_result" | jq -r '.result')" = "saved" ]; then
    log INFO "Host entry created successfully"
else
    log ERROR "Error: Failed to add host entry. API response: $add_result" >&2
    exit 1
fi

log INFO "Reloading config..."
reconfigure_result=$(opnsense_dnsmasq_api "service/reconfigure")

if [ "$(printf '%s' "$reconfigure_result" | jq -r '.status')" = "ok" ]; then
    log INFO "Config reloaded successfully"
else
    log ERROR "Error: Failed to reload config. API response: $reconfigure_result" >&2
    exit 1
fi
